<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.hyundae_futurenet.rocketddan.runners_hi.backend.model.mapper.feed.FeedMapper">

    <!-- FeedFilePath 매핑 -->
    <resultMap id="FeedFilePathMap"
               type="org.hyundae_futurenet.rocketddan.runners_hi.backend.model.dto.business.FeedListSource$FeedFilePath">
        <result property="order" column="fileOrder"/>
        <result property="filePath" column="filePath"/>
    </resultMap>

    <!-- CommentThumbnailRaw 매핑 -->
    <resultMap id="CommentThumbnailMap"
               type="org.hyundae_futurenet.rocketddan.runners_hi.backend.model.dto.business.FeedListSource$CommentThumbnailRaw">
        <result property="content" column="content"/>
        <result property="writerNickname" column="nickname"/>
        <result property="writerProfilePath" column="profilePath"/>
    </resultMap>

    <!-- FeedListSource 메인 매핑 -->
    <resultMap id="FeedListSourceMap"
               type="org.hyundae_futurenet.rocketddan.runners_hi.backend.model.dto.business.FeedListSource">
        <id property="feedId" column="feedId"/>
        <result property="content" column="content"/>
        <result property="writerId" column="writerId"/>
        <result property="writerNickname" column="writerNickname"/>
        <result property="writerProfilePath" column="writerProfilePath"/>
        <result javaType="boolean" property="isMine" column="isMine"/>
        <result property="commentCount" column="commentCount"/>
        <result property="createdAt" column="createdAt"/>

        <!-- 연관된 리스트들 -->
        <collection property="feedFilePathList"
                    ofType="org.hyundae_futurenet.rocketddan.runners_hi.backend.model.dto.business.FeedListSource$FeedFilePath"
                    select="selectFeedFilesByFeedId"
                    column="feedId"/>
        <collection property="commentList"
                    ofType="org.hyundae_futurenet.rocketddan.runners_hi.backend.model.dto.business.FeedListSource$CommentThumbnailRaw"
                    select="selectCommentThumbnailsByFeedId"
                    column="feedId"/>
    </resultMap>

    <!-- 메인 피드 쿼리 -->
    <select id="selectFeedsByFilter" resultMap="FeedListSourceMap">
        SELECT F.FEED_ID                                      AS feedId,
               F.CONTENT                                      AS content,
               F.CREATED_BY                                   AS writerId,
               M.NICKNAME                                     AS writerNickname,
               M.PROFILE_PATH                                 AS writerProfilePath,
               CASE
                   WHEN F.CREATED_BY = #{loginMemberId} THEN 1
                   ELSE 0
                   END                                        AS isMine,
               (SELECT COUNT(*)
                FROM FEED_COMMENT FC
                WHERE FC.FEED_ID = F.FEED_ID)                 AS commentCount,
               TO_CHAR(F.CREATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS "createdAt"
        FROM FEED F
                 JOIN MEMBER M ON F.CREATED_BY = M.MEMBER_ID

    </select>

    <!-- FeedFilePath 목록 조회 -->
    <select id="selectFeedFilesByFeedId" resultMap="FeedFilePathMap">
        SELECT FILE_ORDER AS fileOrder,
               FILE_PATH  AS filePath
        FROM FEED_FILE
        WHERE FEED_ID = #{feedId}
        ORDER BY FILE_ORDER
    </select>

    <!-- CommentThumbnailRaw 목록 조회 -->
    <select id="selectCommentThumbnailsByFeedId" resultMap="CommentThumbnailMap">
        SELECT M.PROFILE_PATH AS profilePath,
               M.NICKNAME     AS nickname,
               FC.CONTENT     AS content
        FROM FEED_COMMENT FC
                 JOIN MEMBER M ON FC.CREATED_BY = M.MEMBER_ID
        WHERE FC.FEED_ID = #{feedId}
        ORDER BY FC.CREATED_AT DESC FETCH FIRST 3 ROWS ONLY
    </select>

</mapper>